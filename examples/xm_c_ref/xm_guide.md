## XM on GBA with Maxmod + mmutil (Quick Guide)

This guide shows the minimum you need to play an XM module in a GBA ROM using Maxmod and the original C mmutil toolchain.

### Prerequisites
- **devkitPro/devkitARM** installed (provides `libgba`, `arm-none-eabi-*`, `gbafix`).
- **libmm (Maxmod for GBA)** available via devkitPro (`-lmm`).
- **mmutil (C)** built at `mmutil/source/mmutil` (or in PATH).

### 1) Convert XM to a soundbank (MSL)
Use mmutil to create a Maxmod soundbank binary and header. For GBA, do not pass `-d` (that is for DS):

```bash
# Single XM → soundbank.bin + soundbank.h
mmutil your_song.xm -osoundbank.bin -hsoundbank.h
```

- **soundbank.bin**: Contains all samples and modules.
- **soundbank.h**: Defines `MOD_*` IDs and `MSL_*` counts. You will include this in your ROM code.

Tip: You can pass multiple inputs (XM/IT/MOD/S3M/WAV). mmutil will pack them all and generate IDs for each module (`MOD_*`) and samples (`SFX_*`).

### 2) Embed the soundbank in the ROM
Convert `soundbank.bin` into an object with `objcopy`, or use your template’s `bin2o` rule.

Makefile snippet (objcopy style):
```make
SOUNDBANK_OBJ := soundbank.o

$(SOUNDBANK_OBJ): soundbank.bin
	$(OBJCOPY) -I binary -O elf32-littlearm -B arm \
	  --rename-section .data=.rodata,alloc,load,readonly,data,contents \
	  soundbank.bin $@
```

This exposes `_binary_soundbank_bin_start` (and `_end/_size`), which you pass to Maxmod.

### 3) Initialize Maxmod and play the module
A minimal C entry point (GBA/libgba):

```c
#include <gba.h>
#include <maxmod.h>
#include "soundbank.h" // generated by mmutil

int main(void) {
    irqInit();
    irqSet(IRQ_VBLANK, mmVBlank);
    irqEnable(IRQ_VBLANK);

    // Optional: set a video mode; here a simple backdrop
    REG_DISPCNT = MODE_3 | BG2_ON;

    // Ensure sound bias
    *(volatile u16*)0x04000088 = 0x200;

    extern const unsigned char _binary_soundbank_bin_start[];
    mmInitDefault((mm_addr)_binary_soundbank_bin_start, /*channels*/ 32);

    // Master volumes (0..1024)
    mmSetModuleVolume(0x400);
    mmSetEffectsVolume(0x400);

    // Start your module using the ID from soundbank.h
    mmStart(MOD_YOUR_SONG, MM_PLAY_LOOP);

    while (1) {
        mmFrame();         // process music + mixing (must be called every frame)
        VBlankIntrWait();  // 60 Hz cadence
    }
}
```

Link flags (devkitPro):
```make
# Link with libmm and libgba
$(CC) -specs=gba.specs ... -lmm -lgba -lc -lgcc -o your.elf
```

### 4) Build the ROM
Typical end of link rule:
```make
$(OBJCOPY) -O binary your.elf your.gba
gbafix your.gba -t"TITLE" -cABCD -m00 -r00
```

### Notes on configuration
- **Channels**: XM modules can use many channels; allocate enough (e.g. 24–32). Too few channels can cut voices.
- **Mix rate**: `mmInitDefault` uses 16 KHz. If you need more CPU headroom with many channels, consider custom init (non-default) at 13 KHz. Start with defaults first.
- **Timing**: Call `mmFrame()` every frame and wire VBlank to `mmVBlank`. Missing frames cause glitches.
- **Tempo/Pitch**: Avoid overriding with `mmSetModuleTempo/Pitch()` unless you need to; XM timing comes from the module header.
- **Sound bias**: Set `*(vu16*)0x04000088 = 0x200;` once at startup.

### Alternative: Play a single MAS directly (no soundbank)
If you want to test one module without a bank:

```bash
# XM → MAS
mmutil -m your_song.xm -oyour_song.mas
```

Then embed `your_song.mas` and play it by skipping the MAS prefix:

```c
extern const unsigned char _binary_your_song_mas_start[];
const unsigned char* mas = _binary_your_song_mas_start;
mmPlayModule((mm_word)(mas + sizeof(mm_mas_prefix)), MM_PLAY_LOOP, /*layer*/ 0);
```

Even in this mode, you still must initialize Maxmod with a valid soundbank pointer (a tiny valid header or a real bank). Using a real bank via `mmInitDefault()` is simplest and recommended.

### Common pitfalls
- **Not using the header IDs**: Hardcoding `mmStart(0, ...)` may play the wrong module. Use `soundbank.h`’s `MOD_*`.
- **Forgetting `mmFrame()`**: Must be called every frame (60 Hz), otherwise timing and mixing break.
- **Linking Maxmod sources directly**: Prefer `-lmm` from devkitPro; it matches the headers and avoids ABI drift.
- **Too few channels**: Voices will cut; increase channel count.
- **Overriding tempo/pitch**: Can cause wrong speed/pitch versus module’s intended values.

### Checklist (GBA)
- **Convert** XM → `soundbank.bin` + `soundbank.h` with mmutil.
- **Embed** `soundbank.bin` (objcopy or bin2o).
- **Init** `mmInitDefault(soundbank, channels)`; hook VBlank to `mmVBlank`.
- **Start** `mmStart(MOD_..., MM_PLAY_LOOP)`.
- **Loop** `mmFrame(); VBlankIntrWait();`.

That’s it. With this pipeline, you’re using mmutil’s canonical output and libmm’s documented init, which yields correct timing, notes, and instruments on GBA. 